<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

  <h:head>
    <meta charset="UTF-8" />
    <meta name="google" content="notranslate" />
    <meta http-equiv="Content-Language" content="en_US" />
    <title>Agnos user management</title>
    <c:set var="isHacked" value="#{!login.isPermitted('USERADMIN', true)}" scope="request" />        
  </h:head>

  <h:body style="background: black; opacity: 0">

    <ui:include src="header.xhtml" />  

    <!-- Nincs jogosultsága üzenet -->
    <h2>
      <h:outputText rendered="#{isHacked}" styleClass="centeredContent" value="Forbidden area ..." />
    </h2>
    <h3>
      <p:link rendered="#{isHacked}" styleClass="centeredContent" value="Back to the start page" outcome="/index.xhtml" />
    </h3> 

    <!-- Csoport szerkesztése dialógus -->
    <p:dialog draggable="false" resizable="false" styleClass="editRoleDialog dialog" header="Modify a security group" widgetVar="editRoleDialog" modal="true">
      <h:form id="editRoleForm">

        <p:panelGrid style="width:100%; padding:1em">

          <p:row>
            <p:column style="width:1%" styleClass="borderT borderL">
              <label>Group name</label>
              <br />
              <p:inputText
                  value="#{userManagement.selectedRole.name}"
                  styleClass="textField noSpellcheck"
                  disabled="#{userManagement.deleteCurrentRole or userManagement.selectedRole.permanent}"/>
            </p:column>
            <p:column style="width:98%" styleClass="borderT">                  
            </p:column>
            <p:column style="white-space:nowrap" styleClass="borderT borderR">                
              <br />
              <p:selectBooleanCheckbox                    
                  id="deleteRole"
                  itemLabel="Delete"
                  value="#{userManagement.deleteCurrentRole}"                    
                  styleClass="deleteCheckBox"
                  disabled="#{userManagement.oldRoleName eq null or userManagement.selectedRole.permanent or userManagement.selectedRoleUsedByReports}"
                  style="width:100%"> 
                <p:ajax process=":editRoleForm" update=":editRoleForm"/>    
              </p:selectBooleanCheckbox>
            </p:column>                                                         
          </p:row>

          <p:row>
            <p:column colspan="3" style="width:100%" styleClass="borderL borderR">
              <label>Description of the security group</label>
              <br />
              <p:inputText
                  value="#{userManagement.selectedRole.description}"
                  styleClass="textFieldFull noSpellcheck"                  
                  disabled="#{userManagement.deleteCurrentRole or userManagement.selectedRole.permanent}"/>
            </p:column>
          </p:row>          

          <p:row>
            <p:column colspan="4" styleClass="borderL borderB borderR">
              <hr />
              <label>Members</label>
              <br />
              <p:selectManyCheckbox
                  id="userRoles" 
                  value="#{userManagement.userNamesInRole}"                    
                  layout="grid"
                  columns="3"                    
                  style="width:100%"
                  disabled="#{userManagement.deleteCurrentRole}">
                <f:selectItems
                    value="#{userManagement.users}"
                    itemDisabled="#{item.permanent}"
                    var="item"
                    itemLabel="#{item.name}"
                    itemValue="#{item.name}" />
              </p:selectManyCheckbox>
            </p:column>                             
          </p:row>            

        </p:panelGrid>  

        <div class="bottomButtonsDiv">
          <p:commandButton
              ajax="true"
              styleClass="saveButton"
              value="#{userManagement.deleteCurrentRole ? 'Delete' : 'Save'}"              
              process=":editRoleForm"
              update=":userManagementForm"
              actionListener="#{userManagement.saveRole()}"
              oncomplete="PF('editRoleDialog').hide();"/>
          <p:commandButton
              styleClass="cancelButton"
              value="Cancel"
              type="button"
              onclick="PF('editRoleDialog').hide();"/>                          
        </div>

      </h:form>
    </p:dialog>     




    <!-- Felhasználó szerkesztése dialógus -->
    <p:dialog  draggable="false" resizable="false" styleClass="editUserDialog dialog" header="Modify user data" widgetVar="editUserDialog" modal="true">
      <h:form id="editUserForm">

        <p:panelGrid style="width:100%; padding:1em">

          <p:row>
            <p:column style="width:1%" styleClass="borderT borderL">
              <label>Username</label>
              <p:message for="username" display="text" styleClass="inlineErrorMessage"/>              
              <br />
              <p:inputText
                  id="username"
                  value="#{userManagement.selectedUser.name}"
                  styleClass="textField noSpellcheck"
                  disabled="#{userManagement.deleteCurrentUser or userManagement.selectedUser.permanent}"
                  validatorMessage="(min.&nbsp;2&nbsp;karakter)"                  >
                <f:validateLength minimum="2" />
                <p:clientValidator event="keyup" />
              </p:inputText>
            </p:column>
            <p:column style="width:98%" styleClass="borderT">                  
            </p:column>
            <p:column style="width:1%" styleClass="borderT">
              <label>Password</label>
              <p:message for="password" display="text" styleClass="inlineErrorMessage"/>
              <br />
              <p:inputText
                  id="password"
                  placeholder="#{userManagement.oldUserName eq null ? '' : 'don\'t change'}"
                  value="#{userManagement.selectedUser.plainPassword}"
                  styleClass="textField noSpellcheck"
                  disabled="#{userManagement.deleteCurrentUser or userManagement.selectedUser.permanent}"
                  validatorMessage="(min.&nbsp;6&nbsp;karakter)"                  
                  >                
                <f:validateLength minimum="6" />
                <p:clientValidator event="keyup" />
              </p:inputText>
            </p:column>
            <p:column style="white-space:nowrap" styleClass="borderT borderR">                
              <br />
              <p:selectBooleanCheckbox                    
                  id="deleteUser"
                  itemLabel="Delete"
                  value="#{userManagement.deleteCurrentUser}"                    
                  styleClass="deleteCheckBox"
                  disabled="#{userManagement.oldUserName eq null or userManagement.selectedUser.permanent}"
                  style="width:100%"> 
                <p:ajax process="@this" update=":editUserForm"/>    
              </p:selectBooleanCheckbox>
            </p:column>                                                         
          </p:row>                  

          <p:row>             
            <p:column styleClass="borderL">
              <label>Real name</label>
              <br />
              <p:inputText
                  value="#{userManagement.selectedUser.realName}"
                  styleClass="textField noSpellcheck"
                  disabled="#{userManagement.deleteCurrentUser or userManagement.selectedUser.permanent}">
              </p:inputText>
            </p:column>

            <p:column styleClass="">                  
            </p:column>

            <p:column styleClass="">
              <label>Email address</label>
              <br />
              <p:inputText
                  value="#{userManagement.selectedUser.email}"
                  styleClass="textField noSpellcheck"
                  disabled="#{userManagement.deleteCurrentUser or userManagement.selectedUser.permanent}">                
              </p:inputText>
            </p:column>

            <p:column style="white-space:nowrap" styleClass="borderR">                
              <br />
            </p:column>                                                         
          </p:row>        

          <p:row>
            <p:column colspan="4" styleClass="borderL borderB borderR">
              <hr />
              <label>Group membership</label>
              <br />
              <p:selectManyCheckbox
                  id="userRoles" 
                  value="#{userManagement.selectedUser.roles}"                    
                  styleClass="dualTable"
                  layout="grid"
                  columns="3"                    
                  style="width:100%"
                  disabled="#{userManagement.deleteCurrentUser or userManagement.selectedUser.permanent}">
                <f:selectItems value="#{userManagement.roleNames}" var="item" itemLabel="#{item}" itemValue="#{item}" />
              </p:selectManyCheckbox>

            </p:column>                             
          </p:row>            

        </p:panelGrid>  

        <div class="bottomButtonsDiv">
          <p:commandButton
              id="saveButton"
              disabled="#{userManagement.selectedUser.permanent}"
              ajax="true"
              styleClass="saveButton"
              value="#{userManagement.deleteCurrentUser ? 'Delete' : 'Save'}"
              process=":editUserForm"
              update=":userManagementForm"
              validateClient="true"
              actionListener="#{userManagement.saveUser()}"
              oncomplete="if (args &amp;&amp; !args.validationFailed) PF('editUserDialog').hide();" />

          <p:commandButton
              styleClass="cancelButton"
              value="Cancel"
              type="button"
              onclick="PF('editUserDialog').hide();"/>                          
        </div>

      </h:form>
    </p:dialog>        




    <h:form id="userManagementForm" rendered="#{!isHacked}">

      <p:fieldset legend="Manage users" toggleable="false">
        <p:dataTable
            paginatorPosition="bottom"
            paginator="true"
            draggableColumns="false"
            widgetVar="existingUsersTable"
            rowIndexVar="rowId"
            id="existingUsersTable"
            emptyMessage="There are no users yet"
            rows="10"          
            value="#{userManagement.users}"          
            selectionMode="single"
            rowKey="#{item.name}"
            selection="#{userManagement.selectedUser}"
            var="item"
            scrollable="false"
            styleClass="searchResultTable"
            stickyHeader="false"
            rowsPerPageTemplate="10,25,50,100"
            currentPageReportTemplate="{startRecord}-{endRecord}, total {totalRecords} users"
            paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
            >

          <p:ajax event="rowSelect" listener="#{userManagement.editSelectedUser()}" process="existingUsersTable" update=":editUserForm" oncomplete="PF('editUserDialog').show(); jQuery('.noSpellcheck').attr('spellcheck','false')" />

          <p:column            
              headerText="Username"
              sortBy="#{item.name}"
              visible="true"
              styleClass="borderL tableBorder"
              width="10">
            <h:outputLabel value="#{item.name}"/>
          </p:column>

          <p:column            
              headerText="Name"
              sortBy="#{item.realName}"
              visible="true"
              styleClass="borderL tableBorder blackBorderInsideL"
              width="10">
            <h:outputLabel value="#{item.realName}"/>
          </p:column>

          <p:column            
              headerText="Group membership"
              sortBy="#{item.roleNamesString}"
              visible="true"
              styleClass="borderR tableBorder blackBorderInsideL"
              width="80">
            <h:outputLabel value="#{item.roleNamesString}"/>
          </p:column>


        </p:dataTable>      

        <div class="bottomButtonsDiv">
          <p:commandButton styleClass="saveButton" value="Add user"  actionListener="#{userManagement.editNewUser()}" ajax="true" process="@this" update=":editUserForm" oncomplete="PF('editUserDialog').show()" />
        </div>

      </p:fieldset>        

      <p:fieldset legend="Manage security gropups" toggleable="false">
        <p:dataTable
            paginatorPosition="bottom"
            paginator="true"
            draggableColumns="false"
            widgetVar="existingRolesTable"
            rowIndexVar="rowId"
            id="existingRolesTable"
            emptyMessage="No groups"
            rows="10"
            value="#{userManagement.roles}"
            selectionMode="single"
            rowKey="#{item.name}"
            selection="#{userManagement.selectedRole}"            
            var="item"          
            scrollable="false"
            styleClass="searchResultTable"
            stickyHeader="false"
            rowsPerPageTemplate="10,25,50,100"
            currentPageReportTemplate="{startRecord}-{endRecord}, total {totalRecords} groups"
            paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
            >

          <p:ajax event="rowSelect" listener="#{userManagement.editSelectedRole()}" process="existingRolesTable" update=":editRoleForm" oncomplete="PF('editRoleDialog').show(); jQuery('.noSpellcheck').attr('spellcheck','false')" />          

          <p:column            
              headerText="Group"
              sortBy="#{item.name}"
              styleClass="borderL tableBorder"
              width="10">
            <h:outputLabel value="#{item.name}"/>
          </p:column>

          <p:column            
              headerText="Description"
              sortBy="#{item.description}"
              styleClass="borderR tableBorder blackBorderInsideL"
              width="90">
            <h:outputLabel value="#{item.description}"/>
          </p:column>


        </p:dataTable>            

        <div class="bottomButtonsDiv">
          <p:commandButton styleClass="saveButton" value="New group"  actionListener="#{userManagement.editNewRole()}" ajax="true" process="@this" update=":editRoleForm" oncomplete="PF('editRoleDialog').show()" />
        </div>

      </p:fieldset>

    </h:form>
  </h:body>
</html>